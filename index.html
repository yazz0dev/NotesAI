<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Notes & Tasks</title>

    <meta name="description" content="An intelligent notes and tasks application with AI-powered features." />
    <meta name="theme-color" content="#ffffff" />
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100%22><text y=%22.9em%22 font-size=%2290%22>üìù</text></svg>">

    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="preconnect" href="https://unpkg.com" crossorigin>
    
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" as="style">
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" as="style">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"/>
    
    <link rel="stylesheet" href="styles/theme.css" />
    <link rel="stylesheet" href="styles/main.css" />
  </head>
  <body>
    <div id="app" class="app-layout">
      <skeleton-loader v-if="isLoading"></skeleton-loader>
      <template v-else>
        <app-header
          :is-voice-active="isVoiceActive"
          :is-sidebar-collapsed="sidebarCollapsed"
          :current-layout="currentLayout"
          :sort-label="getSortLabel()"
          @open-settings="isSettingsModalVisible = true"
          @open-help="openHelp"
          @voice-toggle="handleVoiceToggle"
          @toggle-sidebar="toggleSidebar"
          @toggle-layout="toggleLayout"
          @change-sort="handleSortChange"
        >
          <template #ai-status>
            <div class="ai-status-container text-center" v-if="aiStatus.status !== 'disabled'">
              <small :class="getAIStatusClass()">{{ aiStatus.message }}</small>
            </div>
          </template>

          <template #toolbar>
            <div class="header-toolbar d-flex align-items-center px-4">
              <div class="search-container position-relative flex-grow-1 me-3" :class="{ 'ai-active': isAiSearchActive }">
                <div class="input-group">
                  <span class="input-group-text border-end-0">
                    <i class="bi bi-search"></i>
                  </span>
                  <div
                    id="search-input"
                    class="form-control border-start-0 border-end-0"
                    contenteditable="true"
                    @input="handleSearchInput($event.target.textContent)"
                    @keydown.enter.prevent="submitSearch($event.target.textContent)"
                    placeholder="Search notes or ask AI...">
                  </div>
                  <button
                    class="btn btn-outline-secondary border-start-0"
                    :class="{ 'active': isAiSearchActive }"
                    @click="toggleAiSearch"
                    title="Toggle AI-powered Search"
                    id="ai-search-toggle"
                  >
                    <i class="bi bi-stars"></i>
                  </button>
                </div>
              </div>
              <div class="toolbar-right d-flex gap-2">
                <div class="btn-group" role="group">
                  <button @click="toggleLayout" class="btn btn-outline-secondary" :title="`Switch to ${currentLayout === 'grid' ? 'list' : 'grid'} view`">
                    <i :class="['bi', currentLayout === 'grid' ? 'bi-list' : 'bi-grid-3x3-gap']"></i>
                    <span class="d-none d-lg-inline ms-1">{{ currentLayout === 'grid' ? 'List' : 'Grid' }}</span>
                  </button>
                  <button @click="handleSortChange" class="btn btn-outline-secondary" title="Change Sort Order">
                    <i class="bi bi-sort-down"></i>
                    <span class="d-none d-lg-inline ms-1">{{ getSortLabel() }}</span>
                  </button>
                </div>
              </div>
            </div>
          </template>
        </app-header>

        <div class="d-flex">
          <app-sidebar
            :current-view="currentView"
            :all-tags="allTags"
            :newTagName="newTagName"
            :sidebar-collapsed="sidebarCollapsed"
            @update:new-tag-name="(value) => { newTagName = value; }"
            @switch-view="switchView"
            @create-note="createNewNote"
            @tag-click="handleTagClick"
            @create-tag="handleCreateTag"
          ></app-sidebar>

          <div class="main-content-wrapper">
            <div class="d-flex flex-grow-1 overflow-hidden">
                <div class="main-content-left">
                    <!-- Notice Board - Conditionally rendered based on view context -->
                    <notice-board
                      v-if="isNoticeBoardAvailable"
                      :is-visible="isNoticeBoardVisible"
                      :content="noticeBoardContent"
                      :is-loading="isNoticeBoardLoading"
                      :is-editor-open="!!editingNote"
                      @toggle-visibility="toggleNoticeBoard"
                      @refresh="refreshNoticeBoard"
                      @navigate-to-note="handleNavigateToNote"
                    ></notice-board>
                    
                    <main class="main-content flex-fill">
                      <notes-list
                        :notes="filteredNotes"
                        :layout="currentLayout"
                        :all-tags="allTags"
                        @edit-note="editNote"
                        @delete-note="deleteNote"
                        @toggle-favorite="handleToggleFavorite"
                        @archive-note="handleArchiveNote"
                        @open-tag-modal="openTagModal"
                        @set-reminder="setReminder"
                        @remove-reminder="handleRemoveReminder"
                        @create-note="createNewNote"
                      ></notes-list>
                    </main>
                </div>

                <div class="editor-resizer" v-if="editingNote" @mousedown="startResize"></div>

                <note-editor
                    v-if="editingNote"
                    :note="editingNote"
                    :save-status="saveStatus"
                    @save="saveNote"
                    @close="closeEditor"
                ></note-editor>
            </div>
          </div>
        </div>
      </template>

      <!-- Modals -->
      <settings-modal v-if="isSettingsModalVisible" v-model="handsFreeMode" :current-theme="currentTheme" :save-voice-recordings="saveVoiceRecordings" @update:theme="setTheme" @update:save-voice-recordings="saveVoiceRecordings = $event" @close="isSettingsModalVisible = false"></settings-modal>
      <alert-modal></alert-modal>
      <tag-selection-modal v-if="noteToTag" :note-to-tag="noteToTag" :all-tags="allTags" @close="closeTagModal" @update-tags="handleUpdateTags" @create-tag="handleCreateTag"></tag-selection-modal>
      
      <help-modal :is-visible="isHelpModalVisible" @close="isHelpModalVisible = false"></help-modal>
    </div>
    
    <!-- Load Vue and Pinia synchronously before the module scripts -->
    <script src="https://cdn.jsdelivr.net/npm/vue@3.5.22/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue-demi@0.14.6/lib/index.iife.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pinia@2.1.7/dist/pinia.iife.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" defer></script>
    
    <script>
      function waitForPinia() {
        if (window.Pinia && window.Vue && window.VueDemi) {
          console.log('Vue, VueDemi, and Pinia loaded successfully');
          console.log('Pinia version:', window.Pinia.version || 'IIFE build (no version info)');
          import('/js/main.js').catch(err => {
            console.error('Failed to load main.js:', err);
          });
        } else {
          const missing = [];
          if (!window.Vue) missing.push('Vue');
          if (!window.VueDemi) missing.push('VueDemi');
          if (!window.Pinia) missing.push('Pinia');
          console.log('Waiting for:', missing.join(', '));
          setTimeout(waitForPinia, 50);
        }
      }
      waitForPinia();
    </script>
  </body>
</html>