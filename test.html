<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Journal - Chrome Built-in AI Test</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 2rem;
        line-height: 1.6;
        background: #f5f5f5;
      }
      .test-section {
        background: white;
        margin: 2rem 0;
        padding: 1.5rem;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      .test-result {
        margin: 1rem 0;
        padding: 1rem;
        border-radius: 4px;
        font-family: monospace;
        white-space: pre-wrap;
      }
      .success {
        background: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
      }
      .error {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
      }
      .warning {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        color: #856404;
      }
      button {
        background: #007bff;
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 4px;
        cursor: pointer;
        margin: 0.5rem 0.5rem 0.5rem 0;
      }
      button:hover {
        background: #0056b3;
      }
      button:disabled {
        background: #6c757d;
        cursor: not-allowed;
      }
      textarea,
      input {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #ddd;
        border-radius: 4px;
        margin: 0.5rem 0;
        font-family: inherit;
      }
      .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 0.5rem;
      }
      .status-available {
        background: #28a745;
      }
      .status-unavailable {
        background: #dc3545;
      }
      .status-checking {
        background: #ffc107;
      }
    </style>
  </head>
  <body>
    <h1>ü§ñ AI Journal - Chrome Built-in AI Test</h1>
    <p>
      This page tests the Chrome AI APIs used by the AI Journal application.
      Ensure you have the required flags enabled in
      <code>chrome://flags</code> and are serving this file from a local server
      (e.g., <code>localhost</code>).
    </p>

    <!-- API Availability Check -->
    <div class="test-section">
      <h2>üîß API Availability Check</h2>
      <p>
        Chrome AI Status:
        <span id="chromeAIStatus" class="status-checking">Checking...</span>
      </p>
      <button id="checkAvailabilityBtn">Check Chrome AI Availability</button>
      <div
        id="availabilityResult"
        class="test-result"
        style="display: none"
      ></div>
    </div>

    <!-- Command Parsing Test -->
    <div class="test-section">
      <h2>üé§ Command Parsing Test</h2>
      <p>
        Test the voice command parsing functionality used for "Hey Journal"
        commands.
      </p>
      <input
        type="text"
        id="commandInput"
        placeholder="Enter a voice command (e.g., 'create a new entry')"
        value="create a new entry"
      />
      <button id="testCommandBtn">Parse Command</button>
      <div id="commandResult" class="test-result" style="display: none"></div>
    </div>

    <!-- Sentiment Analysis Test -->
    <div class="test-section">
      <h2>üòä Sentiment Analysis Test</h2>
      <p>Test the sentiment analysis used for journal entry mood detection.</p>
      <textarea
        id="sentimentInput"
        rows="4"
        placeholder="Enter journal text to analyze sentiment..."
      >
Today was an amazing day! I accomplished so much and felt really productive. Everything went smoothly and I'm excited about tomorrow.</textarea
      >
      <button id="testSentimentBtn">Analyze Sentiment</button>
      <div id="sentimentResult" class="test-result" style="display: none"></div>
    </div>

    <!-- Topic Extraction Test -->
    <div class="test-section">
      <h2>üè∑Ô∏è Topic Extraction Test</h2>
      <p>Test the topic extraction used for tagging journal entries.</p>
      <textarea
        id="topicInput"
        rows="4"
        placeholder="Enter journal text to extract topics..."
      >
I had a great workout at the gym today. Then I met with Sarah for coffee and we discussed our upcoming vacation to Japan. I also finished reading that book about productivity.</textarea
      >
      <button id="testTopicBtn">Extract Topics</button>
      <div id="topicResult" class="test-result" style="display: none"></div>
    </div>

    <!-- Mood Insights Test -->
    <div class="test-section">
      <h2>üìä Mood Insights Test</h2>
      <p>Test the mood pattern analysis across multiple journal entries.</p>
      <div id="moodEntries">
        <div class="entry">
          <input
            type="text"
            class="entry-title"
            placeholder="Entry title"
            value="Great Day"
          />
          <textarea class="entry-content" rows="2" placeholder="Entry content">
Today was fantastic! I achieved all my goals and felt really accomplished.</textarea
          >
        </div>
        <div class="entry">
          <input
            type="text"
            class="entry-title"
            placeholder="Entry title"
            value="Challenging Day"
          />
          <textarea class="entry-content" rows="2" placeholder="Entry content">
Work was stressful today. I felt overwhelmed and frustrated with the deadlines.</textarea
          >
        </div>
        <div class="entry">
          <input
            type="text"
            class="entry-title"
            placeholder="Entry title"
            value="Normal Day"
          />
          <textarea class="entry-content" rows="2" placeholder="Entry content">
Had a regular day at work. Nothing special happened, just the usual routine.</textarea
          >
        </div>
      </div>
      <button id="addEntryBtn">Add Entry</button>
      <button id="testMoodBtn">Generate Mood Insights</button>
      <div id="moodResult" class="test-result" style="display: none"></div>
    </div>

    <script>
      // AI Journal Chrome AI Test Suite
      (async () => {
        // DOM Elements
        const chromeAIStatus = document.getElementById("chromeAIStatus");
        const checkAvailabilityBtn = document.getElementById(
          "checkAvailabilityBtn"
        );
        const availabilityResult =
          document.getElementById("availabilityResult");

        const commandInput = document.getElementById("commandInput");
        const testCommandBtn = document.getElementById("testCommandBtn");
        const commandResult = document.getElementById("commandResult");

        const sentimentInput = document.getElementById("sentimentInput");
        const testSentimentBtn = document.getElementById("testSentimentBtn");
        const sentimentResult = document.getElementById("sentimentResult");

        const topicInput = document.getElementById("topicInput");
        const testTopicBtn = document.getElementById("testTopicBtn");
        const topicResult = document.getElementById("topicResult");

        const moodEntries = document.getElementById("moodEntries");
        const addEntryBtn = document.getElementById("addEntryBtn");
        const testMoodBtn = document.getElementById("testMoodBtn");
        const moodResult = document.getElementById("moodResult");

        // Utility functions
        function showResult(element, content, type = "success") {
          element.textContent = content;
          element.className = `test-result ${type}`;
          element.style.display = "block";
        }

        function setStatusIndicator(status) {
          chromeAIStatus.className = `status-indicator status-${status}`;
          chromeAIStatus.textContent =
            status === "available"
              ? "Available"
              : status === "unavailable"
              ? "Unavailable"
              : "Checking...";
        }

        /**
         * Cleans Chrome AI API response by removing markdown formatting
         * @param {string} response - Raw response from Chrome AI API
         * @returns {string} Clean JSON string
         */
        function cleanAIResponse(response) {
          if (!response) return "";

          // Remove markdown code block markers and extra whitespace
          let cleaned = response
            .replace(/```json\s*/gi, "") // Remove ```json (case insensitive)
            .replace(/```\s*/g, "") // Remove ```
            .replace(/`+/g, "") // Remove any remaining backticks
            .trim();

          // Remove any leading/trailing whitespace and newlines
          cleaned = cleaned.replace(/^\s+|\s+$/g, "");

          return cleaned;
        }

        // === API Availability Check ===
        async function checkChromeAIAvailability() {
          checkAvailabilityBtn.disabled = true;
          checkAvailabilityBtn.textContent = "Checking...";

          try {
            if ("LanguageModel" in self) {
              setStatusIndicator("available");
              showResult(
                availabilityResult,
                `‚úÖ Chrome LanguageModel API is available!\n\nAvailable methods:\n- LanguageModel.create()\n- session.prompt()\n- session.destroy()\n- Can be used for:\n  * Command parsing\n  * Sentiment analysis\n  * Topic extraction\n  * Mood insights`,
                "success"
              );
            } else {
              setStatusIndicator("unavailable");
              showResult(
                availabilityResult,
                `‚ùå Chrome LanguageModel API is not available.\n\nTo enable:\n1. Go to chrome://flags\n2. Enable "Experimental Web Platform features"\n3. Enable "Prompt API for Gemini Nano"\n4. Restart Chrome\n5. Serve this page from localhost`,
                "error"
              );
            }
          } catch (error) {
            setStatusIndicator("unavailable");
            showResult(
              availabilityResult,
              `‚ùå Error checking Chrome AI: ${error.message}`,
              "error"
            );
          }

          checkAvailabilityBtn.disabled = false;
          checkAvailabilityBtn.textContent = "Check Chrome AI Availability";
        }

        // === Command Parsing Test ===
        async function testCommandParsing() {
          const command = commandInput.value.trim();
          if (!command) {
            showResult(
              commandResult,
              "‚ùå Please enter a command to test",
              "error"
            );
            return;
          }

          testCommandBtn.disabled = true;
          testCommandBtn.textContent = "Parsing...";

          try {
            if (!("LanguageModel" in self)) {
              showResult(
                commandResult,
                "‚ùå Chrome LanguageModel API not available",
                "error"
              );
              return;
            }

            // Create language model session
            const session = await LanguageModel.create({
              expectedOutputs: [
                {
                  type: "text",
                  languages: ["en"],
                },
              ],
            });

            const commandPrompt = `
              Analyze the user's command: "${command}".
              Convert it into a JSON object with "action" and "params".
              Possible actions: 'create_entry', 'search_notes', 'delete_current', 'edit_current', 'add_image', 'go_back', 'stop_listening'.
              - For 'search_notes', extract the 'query'.
              - If the command is to start a new entry, use 'create_entry'.
              Respond with only the JSON object. Example: {"action": "search_notes", "params": {"query": "hackathon"}}`;

            const result = await session.prompt(commandPrompt);
            const cleanedResult = cleanAIResponse(result);
            const parsedCommand = JSON.parse(cleanedResult);

            // Clean up session
            session.destroy();

            showResult(
              commandResult,
              `‚úÖ Command parsed successfully!\n\nInput: "${command}"\n\nOutput: ${JSON.stringify(
                parsedCommand,
                null,
                2
              )}`,
              "success"
            );
          } catch (error) {
            showResult(
              commandResult,
              `‚ùå Error parsing command: ${error.message}`,
              "error"
            );
          }

          testCommandBtn.disabled = false;
          testCommandBtn.textContent = "Parse Command";
        }

        // === Sentiment Analysis Test ===
        async function testSentimentAnalysis() {
          const text = sentimentInput.value.trim();
          if (!text) {
            showResult(
              sentimentResult,
              "‚ùå Please enter text to analyze",
              "error"
            );
            return;
          }

          testSentimentBtn.disabled = true;
          testSentimentBtn.textContent = "Analyzing...";

          try {
            if (!("LanguageModel" in self)) {
              showResult(
                sentimentResult,
                "‚ùå Chrome LanguageModel API not available",
                "error"
              );
              return;
            }

            // Create language model session
            const session = await LanguageModel.create({
              expectedOutputs: [
                {
                  type: "text",
                  languages: ["en"],
                },
              ],
            });

            const textContent = text.replace(/<[^>]*>/g, "").trim();
            const sentimentPrompt = `
              Analyze the emotional sentiment of this journal entry and respond with ONLY a JSON object:

              "${textContent}"

              Response format: {"sentiment": "positive|negative|neutral", "confidence": 0.0-1.0, "emoji": "üòä|üòû|üòê", "keywords": ["word1", "word2"]}

              Guidelines:
              - positive: optimistic, happy, grateful, excited, accomplished
              - negative: sad, frustrated, worried, angry, disappointed
              - neutral: factual, routine, balanced, reflective
              - confidence: how certain you are (0.0-1.0)
              - emoji: single emoji that best represents the sentiment
              - keywords: 2-4 key emotional words from the text
            `;

            const result = await session.prompt(sentimentPrompt);
            const cleanedResult = cleanAIResponse(result);
            console.log("Raw AI response:", result);
            console.log("Cleaned AI response:", cleanedResult);
            const analysis = JSON.parse(cleanedResult);

            // Clean up session
            session.destroy();

            const sentiment = ["positive", "negative", "neutral"].includes(
              analysis.sentiment
            )
              ? analysis.sentiment
              : "neutral";
            const confidence = Math.max(
              0,
              Math.min(1, analysis.confidence || 0.5)
            );
            const emoji = analysis.emoji || "üòê";
            const keywords = Array.isArray(analysis.keywords)
              ? analysis.keywords.slice(0, 4)
              : [];

            showResult(
              sentimentResult,
              `‚úÖ Sentiment analysis completed!\n\nText: "${text.substring(
                0,
                100
              )}${
                text.length > 100 ? "..." : ""
              }"\n\nResult: ${sentiment} ${emoji}\nConfidence: ${Math.round(
                confidence * 100
              )}%\nKeywords: ${keywords.join(", ") || "none"}`,
              "success"
            );
          } catch (error) {
            showResult(
              sentimentResult,
              `‚ùå Error analyzing sentiment: ${error.message}`,
              "error"
            );
          }

          testSentimentBtn.disabled = false;
          testSentimentBtn.textContent = "Analyze Sentiment";
        }

        // === Topic Extraction Test ===
        async function testTopicExtraction() {
          const text = topicInput.value.trim();
          if (!text) {
            showResult(topicResult, "‚ùå Please enter text to analyze", "error");
            return;
          }

          testTopicBtn.disabled = true;
          testTopicBtn.textContent = "Extracting...";

          try {
            if (!("LanguageModel" in self)) {
              showResult(
                topicResult,
                "‚ùå Chrome LanguageModel API not available",
                "error"
              );
              return;
            }

            // Create language model session
            const session = await LanguageModel.create({
              expectedOutputs: [
                {
                  type: "text",
                  languages: ["en"],
                },
              ],
            });

            const textContent = text.replace(/<[^>]*>/g, "").trim();
            const topicPrompt = `
              Analyze this journal entry and extract the main topics/themes. Return ONLY a JSON array of strings:

              "${textContent}"

              Response format: ["topic1", "topic2", "topic3"]

              Guidelines:
              - Extract 2-5 main topics/themes
              - Use simple, lowercase terms
              - Focus on: activities, emotions, people, places, events, goals
              - Examples: "work", "family", "health", "travel", "learning", "relationships"
              - Avoid generic terms like "life" or "thoughts"
            `;

            const result = await session.prompt(topicPrompt);
            const cleanedResult = cleanAIResponse(result);
            console.log("Raw AI response:", result);
            console.log("Cleaned AI response:", cleanedResult);
            const topics = JSON.parse(cleanedResult);

            // Clean up session
            session.destroy();

            const validTopics = Array.isArray(topics)
              ? topics
                  .filter(
                    (topic) => typeof topic === "string" && topic.length > 0
                  )
                  .slice(0, 5)
              : [];

            showResult(
              topicResult,
              `‚úÖ Topics extracted successfully!\n\nText: "${text.substring(
                0,
                100
              )}${text.length > 100 ? "..." : ""}"\n\nTopics: ${
                validTopics.length > 0
                  ? validTopics.map((t) => `"${t}"`).join(", ")
                  : "none found"
              }`,
              "success"
            );
          } catch (error) {
            showResult(
              topicResult,
              `‚ùå Error extracting topics: ${error.message}`,
              "error"
            );
          }

          testTopicBtn.disabled = false;
          testTopicBtn.textContent = "Extract Topics";
        }

        // === Mood Insights Test ===
        function addMoodEntry() {
          const entryDiv = document.createElement("div");
          entryDiv.className = "entry";
          entryDiv.innerHTML = `
                    <input type="text" class="entry-title" placeholder="Entry title" value="New Entry">
                    <textarea class="entry-content" rows="2" placeholder="Entry content">Enter journal content here...</textarea>
                `;
          moodEntries.appendChild(entryDiv);
        }

        async function testMoodInsights() {
          const entries = Array.from(moodEntries.querySelectorAll(".entry"))
            .map((entry) => ({
              title: entry.querySelector(".entry-title").value,
              content: entry.querySelector(".entry-content").value,
            }))
            .filter((entry) => entry.content.trim());

          if (entries.length === 0) {
            showResult(
              moodResult,
              "‚ùå Please add at least one entry with content",
              "error"
            );
            return;
          }

          testMoodBtn.disabled = true;
          testMoodBtn.textContent = "Analyzing...";

          try {
            if (!("LanguageModel" in self)) {
              showResult(
                moodResult,
                "‚ùå Chrome LanguageModel API not available",
                "error"
              );
              return;
            }

            // Simulate the mood insights generation from ai-insights.js
            const sentimentPromises = entries.map(async (entry) => {
              // Create language model session for each entry
              const session = await LanguageModel.create({
                expectedOutputs: [
                  {
                    type: "text",
                    languages: ["en"],
                  },
                ],
              });

              const textContent = entry.content.replace(/<[^>]*>/g, "").trim();
              const sentimentPrompt = `
                Analyze the emotional sentiment of this journal entry and respond with ONLY a JSON object:
                "${textContent}"
                Response format: {"sentiment": "positive|negative|neutral", "confidence": 0.0-1.0, "emoji": "üòä|üòû|üòê", "keywords": ["word1", "word2"]}
              `;

              const result = await session.prompt(sentimentPrompt);
              const cleanedResult = cleanAIResponse(result);
              console.log("Raw AI response for", entry.title, ":", result);
              console.log("Cleaned AI response:", cleanedResult);
              const analysis = JSON.parse(cleanedResult);

              // Clean up session
              session.destroy();

              return {
                sentiment: ["positive", "negative", "neutral"].includes(
                  analysis.sentiment
                )
                  ? analysis.sentiment
                  : "neutral",
                confidence: Math.max(
                  0,
                  Math.min(1, analysis.confidence || 0.5)
                ),
                emoji: analysis.emoji || "üòê",
                keywords: Array.isArray(analysis.keywords)
                  ? analysis.keywords.slice(0, 4)
                  : [],
                title: entry.title,
              };
            });

            const sentiments = await Promise.all(sentimentPromises);

            // Calculate mood distribution
            const moodCounts = sentiments.reduce((acc, s) => {
              acc[s.sentiment] = (acc[s.sentiment] || 0) + 1;
              return acc;
            }, {});

            const totalEntries = sentiments.length;
            const positiveRatio = (moodCounts.positive || 0) / totalEntries;
            const negativeRatio = (moodCounts.negative || 0) / totalEntries;

            let pattern = "balanced";
            if (positiveRatio > 0.6) pattern = "mostly_positive";
            else if (negativeRatio > 0.6) pattern = "mostly_negative";
            else if (positiveRatio > negativeRatio * 1.5)
              pattern = "leaning_positive";
            else if (negativeRatio > positiveRatio * 1.5)
              pattern = "leaning_negative";

            showResult(
              moodResult,
              `‚úÖ Mood insights generated!\n\nAnalyzed ${totalEntries} entries:\n` +
                `‚Ä¢ Positive: ${moodCounts.positive || 0} (${Math.round(
                  positiveRatio * 100
                )}%)\n` +
                `‚Ä¢ Negative: ${moodCounts.negative || 0} (${Math.round(
                  negativeRatio * 100
                )}%)\n` +
                `‚Ä¢ Neutral: ${moodCounts.neutral || 0} (${Math.round(
                  (1 - positiveRatio - negativeRatio) * 100
                )}%)\n\n` +
                `Pattern: ${pattern.replace("_", " ")}\n\n` +
                `Individual results:\n${sentiments
                  .map((s) => `‚Ä¢ "${s.title}": ${s.sentiment} ${s.emoji}`)
                  .join("\n")}`,
              "success"
            );
          } catch (error) {
            showResult(
              moodResult,
              `‚ùå Error generating mood insights: ${error.message}`,
              "error"
            );
          }

          testMoodBtn.disabled = false;
          testMoodBtn.textContent = "Generate Mood Insights";
        }

        // Event Listeners
        checkAvailabilityBtn.addEventListener(
          "click",
          checkChromeAIAvailability
        );
        testCommandBtn.addEventListener("click", testCommandParsing);
        testSentimentBtn.addEventListener("click", testSentimentAnalysis);
        testTopicBtn.addEventListener("click", testTopicExtraction);
        addEntryBtn.addEventListener("click", addMoodEntry);
        testMoodBtn.addEventListener("click", testMoodInsights);

        // Initialize with availability check
        checkChromeAIAvailability();
      })();
    </script>
  </body>
</html>
